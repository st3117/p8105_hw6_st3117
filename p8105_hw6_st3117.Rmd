---
title: "p8105_hw6_st3117"
author: "Sha Tao"
date: "November 15, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rvest)
library(httr)
library(modelr)

theme_set(theme_bw())

```

## Problem 1_1

```{r p1_1}

p2_dataset = 
  RCurl::getURL("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") %>%
    read_csv()

```

## Problem 1_2

```{r p1_2}

homicides =
  p2_dataset %>% 
  mutate(victim_race = fct_relevel(ifelse(victim_race == "White", "white", "non-white"), "white"),
         victim_age = ifelse(victim_age == "Unknown", NA, as.integer(victim_age)),
         victim_sex = as.factor(victim_sex),
         city_state = paste(paste0(city, ","), state),
         resolved = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>% 
  select(uid, victim_race, victim_age, victim_sex, city_state, resolved)


```

## Problem 1_3
```{r p1_3}

baltimore_logistic = 
  homicides %>%
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

# save baltimore_logistic as an object
save(baltimore_logistic, file = "Baltimore_logistic.RData")

baltimore_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         conf.low = exp(estimate - 1.96 * std.error),
         conf.high = exp(estimate + 1.96 * std.error)) %>% 
  filter(term == "victim_racenon-white") %>% 
  select(beta = estimate, p.value, OR, conf.low, conf.high) %>% 
  knitr::kable(digit = 3)

```

## Problem 1_4

```{r}

# create function for all city glm
city_logistic = function(x){
  
    homicides %>% 
    filter(city_state == x) %>% 
    glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())  %>% 
    broom::tidy() %>% 
    mutate(OR = exp(estimate),
           conf.low = exp(estimate - 1.96 * std.error),
           conf.high = exp(estimate + 1.96 * std.error)) %>% 
    filter(term == "victim_racenon-white") %>% 
    select(beta = estimate, p.value, OR, conf.low, conf.high)

}

# compute city proportion test
city_result = 
  tibble(city_state = unique(homicides$city_state)) %>% 
  mutate(map(.x = unique(homicides$city_state), ~city_logistic(.x))) %>% 
  unnest


```

## Problem 1_5
```{r}

city_result %>% 
  ggplot(aes(x = reorder(city_state, OR), y = OR)) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.3, size = 7)) +
    labs(
      x = "City",
      y = "Odds Ratio",
      title = "Estimated Odds Ratio for Solving Homicides Comparing Non-white Victims to White Victims"
    )

```

## Problem 2_1

```{r}

children = 
  read_csv(file = "./data/birthweight.csv")

```

```{r}

null_model = lm(bwt ~ 1, data = children)
full_model = lm(bwt ~ ., data = children)

stepwise = step(null_model, scope = list(upper = full_model), data = children, direction = "both")
stepwise %>% broom::tidy()

proposed_model = lm(bwt ~ bhead + blength + babysex + delwt + mrace + gaweeks, data = children)

```

Step-wise selection is a data-driven model-building process, by performing it, we got 13 significant variables.
By simplily searching the association of birth weight and the 13 variables online, I narrowed it down to 6 variables: baby’s head circumference at birth, baby’s length at birth, baby’s sex, mother’s weight at delivery, mother’s race, and gestational age in weeks.

```{r}

resid_fit = 
  children %>% 
  add_predictions(model = proposed_model) %>% 
  add_residuals(model = proposed_model)

ggplot(resid_fit, aes(x = pred, y = resid)) +
    geom_point()
  
```

Three characteristics of a well-behaved residual vs. fits plot and what they suggest about the appropriateness of the simple linear regression model:
* The residuals "bounce randomly" around the 0 line. This suggests that the assumption that the relationship is linear is reasonable.
* The residuals roughly form a "horizontal band" around the 0 line. This suggests that the variances of the error terms are equal.
* No one residual "stands out" from the basic random pattern of residuals. This suggests that there are no outliers.

Overall, except few outliers < 1000 grams, this residual vs. fits plot has fairly random scatter pattern around the 0 line.

```{r}

```




